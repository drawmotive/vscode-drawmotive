(()=>{"use strict";var e={369(e,t,r){var o,n=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=o(e),i=0;i<r.length;i++)"default"!==r[i]&&n(t,e,r[i]);return a(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.DrawmotiveEditorProvider=void 0;const s=i(r(398)),c=r(831);t.DrawmotiveEditorProvider=class{context;static viewType="drawmotive.editor";constructor(e){this.context=e}async openCustomDocument(e,t,r){return{uri:e,dispose:()=>{}}}async resolveCustomEditor(e,t,r){t.webview.options={enableScripts:!0,localResourceRoots:[s.Uri.joinPath(this.context.extensionUri,"media")]},t.webview.html=await this.getHtmlForWebview(t.webview),t.webview.onDidReceiveMessage(async r=>{switch(r.type){case"ready":await this.updateWebview(e.uri,t.webview);break;case"update":await this.updateDocument(e.uri,r.data);break;case"error":s.window.showErrorMessage(`Drawmotive: ${r.error}`)}},null,this.context.subscriptions);const o=s.workspace.createFileSystemWatcher(new s.RelativePattern(e.uri,"*"));o.onDidChange(async()=>{await this.updateWebview(e.uri,t.webview)}),t.onDidDispose(()=>{o.dispose()})}async updateWebview(e,t){try{const r=await s.workspace.fs.readFile(e);console.log(`[DrawmotiveEditorProvider] Read file: ${r.length} bytes`);let o="";if(r.length>0){const e=await(0,c.readPngMetadata)(Buffer.from(r));console.log("[DrawmotiveEditorProvider] Extracted metadata: "+(e?e.substring(0,100)+"...":"null")),e&&(o=e)}console.log(`[DrawmotiveEditorProvider] Sending init message with diagramData length: ${o.length}`),t.postMessage({type:"init",data:{fileId:e.fsPath,diagramData:o,pngData:r.length>0?Buffer.from(r).toString("base64"):""}})}catch(e){console.error("Error updating webview:",e),t.postMessage({type:"error",error:`Failed to load diagram: ${e}`})}}async updateDocument(e,t){try{console.log("[DrawmotiveEditorProvider] updateDocument called with data:",t);const{raw:r,png:o}=t;if(!r||!o)throw console.error("[DrawmotiveEditorProvider] Missing data fields:",{hasRaw:!!r,hasPng:!!o}),new Error("Missing required data fields (raw or png)");console.log(`[DrawmotiveEditorProvider] Received raw data length: ${r.length}, png data length: ${o.length}`);const n=Buffer.from(o,"base64");console.log(`[DrawmotiveEditorProvider] Decoded PNG buffer: ${n.length} bytes`);const a=await(0,c.writePngWithMetadata)(n,r);console.log(`[DrawmotiveEditorProvider] Final PNG with metadata: ${a.length} bytes`),await s.workspace.fs.writeFile(e,a),console.log("[DrawmotiveEditorProvider] File written successfully")}catch(e){console.error("Error updating document:",e),s.window.showErrorMessage(`Failed to save diagram: ${e}`)}}async getHtmlForWebview(e){const t=s.Uri.joinPath(this.context.extensionUri,"media","editor","index.html"),r=await s.workspace.fs.readFile(t);let o=Buffer.from(r).toString("utf8");const n=e.asWebviewUri(s.Uri.joinPath(this.context.extensionUri,"media","editor"));return o=o.replace(/href="([^"]+)"/g,(e,t)=>t.startsWith("http")?e:`href="${n}/${t}"`),o=o.replace(/src="([^"]+)"/g,(e,t)=>t.startsWith("http")?e:`src="${n}/${t}"`),o=o.replace("<head>",`<head>\n    <meta http-equiv="Content-Security-Policy" content="\n        default-src 'none';\n        script-src ${e.cspSource} 'unsafe-eval' 'unsafe-inline' 'wasm-unsafe-eval';\n        script-src-elem ${e.cspSource} 'unsafe-inline';\n        style-src ${e.cspSource} 'unsafe-inline';\n        img-src ${e.cspSource} data: blob:;\n        font-src ${e.cspSource};\n        connect-src ${e.cspSource} http://localhost data: blob:;\n        worker-src ${e.cspSource} blob:;\n        child-src ${e.cspSource} blob:;\n    ">`),o}}},398(e){e.exports=require("vscode")},784(e,t,r){var o,n=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=o(e),i=0;i<r.length;i++)"default"!==r[i]&&n(t,e,r[i]);return a(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.activate=function(e){console.log("Drawmotive extension activated");const t=new c.DrawmotiveEditorProvider(e),r=s.window.registerCustomEditorProvider("drawmotive.editor",t,{webviewOptions:{retainContextWhenHidden:!0},supportsMultipleEditorsPerDocument:!1});e.subscriptions.push(r);const o=s.commands.registerCommand("drawmotive.newDrawing",async()=>{const e=await s.window.showSaveDialog({filters:{"Drawmotive Diagrams":["draw.png"]},saveLabel:"Create Drawing"});if(e){const t=(0,l.createEmptyPng)();await s.workspace.fs.writeFile(e,t),await s.commands.executeCommand("vscode.openWith",e,"drawmotive.editor")}});e.subscriptions.push(o)},t.deactivate=function(){console.log("Drawmotive extension deactivated")};const s=i(r(398)),c=r(369),l=r(831)},831(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.readPngMetadata=async function(e){try{if(0===e.length)return null;const t=o(e,r);return t?(console.log("[readPngMetadata] Found metadata with key:",r,"length:",t.length),t):(console.log("[readPngMetadata] No metadata found with key:",r),null)}catch(e){return console.error("[readPngMetadata] Error:",e),null}},t.writePngWithMetadata=async function(e,t){try{console.log("[writePngWithMetadata] Adding metadata, length:",t.length);const n=function(e,t){const r=Buffer.from([137,80,78,71,13,10,26,10]);if(!e.subarray(0,8).equals(r))throw new Error("Invalid PNG signature");const o=[r];let n=8;for(;n+12<=e.length;){const r=e.readUInt32BE(n),a=e.subarray(n+4,n+8).toString("ascii");if(n+12+r>e.length)break;const i=12+r,s=e.subarray(n,n+i);if("tEXt"===a){const o=e.subarray(n+8,n+8+r),a=o.indexOf(0);if(a>0&&o.subarray(0,a).toString("latin1")===t){n+=i;continue}}if(o.push(s),n+=i,"IEND"===a)break}return Buffer.concat(o)}(e,r),a=function(e,t,r){const o=Buffer.from([137,80,78,71,13,10,26,10]);if(!e.subarray(0,8).equals(o))throw new Error("Invalid PNG signature");let n=-1,a=8;for(;a+8<=e.length;){const t=e.readUInt32BE(a);if("IEND"===e.subarray(a+4,a+8).toString("ascii")){n=a;break}a+=12+t}if(-1===n)throw new Error("IEND chunk not found");const i=Buffer.from(t,"latin1"),s=Buffer.from(r,"latin1"),c=Buffer.concat([i,Buffer.from([0]),s]),l=Buffer.alloc(4);l.writeUInt32BE(c.length,0);const u=Buffer.from("tEXt","ascii"),d=Buffer.alloc(4);d.writeUInt32BE(function(e){let t=4294967295;for(let r=0;r<e.length;r++){t^=e[r];for(let e=0;e<8;e++)1&t?t=t>>>1^3988292384:t>>>=1}return(4294967295^t)>>>0}(Buffer.concat([u,c])),0);const f=Buffer.concat([l,u,c,d]);return Buffer.concat([e.subarray(0,n),f,e.subarray(n)])}(n,r,t);console.log("[writePngWithMetadata] Output buffer size:",a.length);const i=o(a,r);return console.log("[writePngWithMetadata] Verification:",!!i,"length:",i?.length),a}catch(e){throw console.error("[writePngWithMetadata] Error:",e),e}},t.createEmptyPng=function(){return Buffer.from([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,3,32,0,0,2,88,8,6,0,0,0,219,63,87,159,0,0,0,10,73,68,65,84,120,156,99,0,1,0,0,5,0,1,13,10,45,180,0,0,0,0,73,69,78,68,174,66,96,130])};const r="drawmotive";function o(e,t){const r=Buffer.from([137,80,78,71,13,10,26,10]);if(!e.subarray(0,8).equals(r))throw new Error("Invalid PNG signature");let o=8;for(;o+12<=e.length;){const r=e.readUInt32BE(o),n=e.subarray(o+4,o+8).toString("ascii");if(o+12+r>e.length)break;if("tEXt"===n){const n=e.subarray(o+8,o+8+r),a=n.indexOf(0);if(a>0&&n.subarray(0,a).toString("latin1")===t)return n.subarray(a+1).toString("latin1")}if("IEND"===n)break;o+=12+r}return null}}},t={},r=function r(o){var n=t[o];if(void 0!==n)return n.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,r),a.exports}(784);module.exports=r})();