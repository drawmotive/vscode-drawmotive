{"version":3,"file":"extension.js","mappings":"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","sources":["webpack://vscode-drawmotive/./src/DrawmotiveEditorProvider.ts","webpack://vscode-drawmotive/external commonjs \"vscode\"","webpack://vscode-drawmotive/./src/extension.ts","webpack://vscode-drawmotive/./src/pngMetadata.ts","webpack://vscode-drawmotive/webpack/bootstrap","webpack://vscode-drawmotive/webpack/startup"],"sourcesContent":["import * as vscode from 'vscode';\r\nimport { readPngMetadata, writePngWithMetadata } from './pngMetadata';\r\n\r\n/**\r\n * Provider for Drawmotive custom editor that handles .draw.png files (binary PNG format)\r\n */\r\nexport class DrawmotiveEditorProvider implements vscode.CustomReadonlyEditorProvider {\r\n    private static readonly viewType = 'drawmotive.editor';\r\n\r\n    constructor(private readonly context: vscode.ExtensionContext) {}\r\n\r\n    public async openCustomDocument(\r\n        uri: vscode.Uri,\r\n        _openContext: vscode.CustomDocumentOpenContext,\r\n        _token: vscode.CancellationToken\r\n    ): Promise<vscode.CustomDocument> {\r\n        return { uri, dispose: () => {} };\r\n    }\r\n\r\n    public async resolveCustomEditor(\r\n        document: vscode.CustomDocument,\r\n        webviewPanel: vscode.WebviewPanel,\r\n        _token: vscode.CancellationToken\r\n    ): Promise<void> {\r\n        // Setup webview\r\n        webviewPanel.webview.options = {\r\n            enableScripts: true,\r\n            localResourceRoots: [\r\n                vscode.Uri.joinPath(this.context.extensionUri, 'media')\r\n            ]\r\n        };\r\n\r\n        webviewPanel.webview.html = await this.getHtmlForWebview(webviewPanel.webview);\r\n\r\n        // Handle messages from webview\r\n        webviewPanel.webview.onDidReceiveMessage(\r\n            async (message) => {\r\n                switch (message.type) {\r\n                    case 'ready':\r\n                        await this.updateWebview(document.uri, webviewPanel.webview);\r\n                        break;\r\n                    case 'update':\r\n                        await this.updateDocument(document.uri, message.data);\r\n                        break;\r\n                    case 'error':\r\n                        vscode.window.showErrorMessage(`Drawmotive: ${message.error}`);\r\n                        break;\r\n                }\r\n            },\r\n            null,\r\n            this.context.subscriptions\r\n        );\r\n\r\n        // Watch for external file changes\r\n        const watcher = vscode.workspace.createFileSystemWatcher(\r\n            new vscode.RelativePattern(document.uri, '*')\r\n        );\r\n        watcher.onDidChange(async () => {\r\n            await this.updateWebview(document.uri, webviewPanel.webview);\r\n        });\r\n        webviewPanel.onDidDispose(() => {\r\n            watcher.dispose();\r\n        });\r\n    }\r\n\r\n    private async updateWebview(fileUri: vscode.Uri, webview: vscode.Webview): Promise<void> {\r\n        try {\r\n            // Read file as binary PNG data\r\n            const fileData = await vscode.workspace.fs.readFile(fileUri);\r\n            console.log(`[DrawmotiveEditorProvider] Read file: ${fileData.length} bytes`);\r\n\r\n            let diagramData = '';\r\n            if (fileData.length > 0) {\r\n                const metadata = await readPngMetadata(Buffer.from(fileData));\r\n                console.log(`[DrawmotiveEditorProvider] Extracted metadata: ${metadata ? metadata.substring(0, 100) + '...' : 'null'}`);\r\n                if (metadata) {\r\n                    diagramData = metadata;\r\n                }\r\n            }\r\n\r\n            console.log(`[DrawmotiveEditorProvider] Sending init message with diagramData length: ${diagramData.length}`);\r\n            webview.postMessage({\r\n                type: 'init',\r\n                data: {\r\n                    fileId: fileUri.fsPath,\r\n                    diagramData: diagramData,\r\n                    pngData: fileData.length > 0 ? Buffer.from(fileData).toString('base64') : ''\r\n                }\r\n            });\r\n        } catch (error) {\r\n            console.error('Error updating webview:', error);\r\n            webview.postMessage({\r\n                type: 'error',\r\n                error: `Failed to load diagram: ${error}`\r\n            });\r\n        }\r\n    }\r\n\r\n    private async updateDocument(fileUri: vscode.Uri, data: any): Promise<void> {\r\n        try {\r\n            console.log('[DrawmotiveEditorProvider] updateDocument called with data:', data);\r\n            const { raw, png } = data;\r\n\r\n            if (!raw || !png) {\r\n                console.error('[DrawmotiveEditorProvider] Missing data fields:', { hasRaw: !!raw, hasPng: !!png });\r\n                throw new Error('Missing required data fields (raw or png)');\r\n            }\r\n\r\n            console.log(`[DrawmotiveEditorProvider] Received raw data length: ${raw.length}, png data length: ${png.length}`);\r\n            const pngBuffer = Buffer.from(png, 'base64');\r\n            console.log(`[DrawmotiveEditorProvider] Decoded PNG buffer: ${pngBuffer.length} bytes`);\r\n\r\n            const finalPngBuffer = await writePngWithMetadata(pngBuffer, raw);\r\n            console.log(`[DrawmotiveEditorProvider] Final PNG with metadata: ${finalPngBuffer.length} bytes`);\r\n\r\n            // Write binary PNG data directly to file\r\n            await vscode.workspace.fs.writeFile(fileUri, finalPngBuffer);\r\n            console.log('[DrawmotiveEditorProvider] File written successfully');\r\n        } catch (error) {\r\n            console.error('Error updating document:', error);\r\n            vscode.window.showErrorMessage(`Failed to save diagram: ${error}`);\r\n        }\r\n    }\r\n\r\n    private async getHtmlForWebview(webview: vscode.Webview): Promise<string> {\r\n        const indexPath = vscode.Uri.joinPath(this.context.extensionUri, 'media', 'editor', 'index.html');\r\n        const indexBytes = await vscode.workspace.fs.readFile(indexPath);\r\n        let html = Buffer.from(indexBytes).toString('utf8');\r\n\r\n        const editorUri = webview.asWebviewUri(\r\n            vscode.Uri.joinPath(this.context.extensionUri, 'media', 'editor')\r\n        );\r\n\r\n        // Convert relative paths to absolute webview URIs\r\n        html = html.replace(/href=\"([^\"]+)\"/g, (match, path) => {\r\n            if (path.startsWith('http')) return match;\r\n            return `href=\"${editorUri}/${path}\"`;\r\n        });\r\n\r\n        html = html.replace(/src=\"([^\"]+)\"/g, (match, path) => {\r\n            if (path.startsWith('http')) return match;\r\n            return `src=\"${editorUri}/${path}\"`;\r\n        });\r\n\r\n        // Add CSP\r\n        html = html.replace('<head>', `<head>\r\n    <meta http-equiv=\"Content-Security-Policy\" content=\"\r\n        default-src 'none';\r\n        script-src ${webview.cspSource} 'unsafe-eval' 'unsafe-inline' 'wasm-unsafe-eval';\r\n        script-src-elem ${webview.cspSource} 'unsafe-inline';\r\n        style-src ${webview.cspSource} 'unsafe-inline';\r\n        img-src ${webview.cspSource} data: blob:;\r\n        font-src ${webview.cspSource};\r\n        connect-src ${webview.cspSource} http://localhost data: blob:;\r\n        worker-src ${webview.cspSource} blob:;\r\n        child-src ${webview.cspSource} blob:;\r\n    \">`);\r\n\r\n        return html;\r\n    }\r\n}\r\n","module.exports = require(\"vscode\");","import * as vscode from 'vscode';\r\nimport { DrawmotiveEditorProvider } from './DrawmotiveEditorProvider';\r\nimport { createEmptyPng } from './pngMetadata';\r\n\r\nexport function activate(context: vscode.ExtensionContext) {\r\n    console.log('Drawmotive extension activated');\r\n\r\n    // Register the custom editor provider for .draw.png files\r\n    const provider = new DrawmotiveEditorProvider(context);\r\n    const registration = vscode.window.registerCustomEditorProvider(\r\n        'drawmotive.editor',\r\n        provider,\r\n        {\r\n            webviewOptions: {\r\n                retainContextWhenHidden: true\r\n            },\r\n            supportsMultipleEditorsPerDocument: false\r\n        }\r\n    );\r\n    context.subscriptions.push(registration);\r\n\r\n    // Register command to create new drawing\r\n    const newDrawingCommand = vscode.commands.registerCommand('drawmotive.newDrawing', async () => {\r\n        const uri = await vscode.window.showSaveDialog({\r\n            filters: {\r\n                'Drawmotive Diagrams': ['draw.png']\r\n            },\r\n            saveLabel: 'Create Drawing'\r\n        });\r\n\r\n        if (uri) {\r\n            // Create a valid empty PNG file (not 0 bytes)\r\n            const emptyPngData = createEmptyPng();\r\n            await vscode.workspace.fs.writeFile(uri, emptyPngData);\r\n\r\n            // Open the newly created file in the editor\r\n            await vscode.commands.executeCommand('vscode.openWith', uri, 'drawmotive.editor');\r\n        }\r\n    });\r\n    context.subscriptions.push(newDrawingCommand);\r\n}\r\n\r\nexport function deactivate() {\r\n    console.log('Drawmotive extension deactivated');\r\n}\r\n","/**\r\n * Simple PNG metadata handler for Drawmotive VSCode extension\r\n * Manually inserts/extracts tEXt chunks from PNG files\r\n */\r\n\r\nconst METADATA_KEY = 'drawmotive';\r\n\r\n/**\r\n * Reads Drawmotive metadata from a PNG file\r\n */\r\nexport async function readPngMetadata(pngBuffer: Buffer): Promise<string | null> {\r\n    try {\r\n        if (pngBuffer.length === 0) {\r\n            return null;\r\n        }\r\n\r\n        const metadata = readTextChunk(pngBuffer, METADATA_KEY);\r\n        if (metadata) {\r\n            console.log('[readPngMetadata] Found metadata with key:', METADATA_KEY, 'length:', metadata.length);\r\n            return metadata;\r\n        }\r\n\r\n        console.log('[readPngMetadata] No metadata found with key:', METADATA_KEY);\r\n        return null;\r\n    } catch (error) {\r\n        console.error('[readPngMetadata] Error:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Writes a PNG file with embedded Drawmotive metadata\r\n */\r\nexport async function writePngWithMetadata(pngBuffer: Buffer, metadata: string): Promise<Buffer> {\r\n    try {\r\n        console.log('[writePngWithMetadata] Adding metadata, length:', metadata.length);\r\n\r\n        // Remove existing drawmotive chunk if present\r\n        const cleanedBuffer = removeTextChunk(pngBuffer, METADATA_KEY);\r\n\r\n        // Insert new tEXt chunk\r\n        const outputBuffer = insertTextChunk(cleanedBuffer, METADATA_KEY, metadata);\r\n\r\n        console.log('[writePngWithMetadata] Output buffer size:', outputBuffer.length);\r\n\r\n        // Verify\r\n        const verifyMetadata = readTextChunk(outputBuffer, METADATA_KEY);\r\n        console.log('[writePngWithMetadata] Verification:', !!verifyMetadata, 'length:', verifyMetadata?.length);\r\n\r\n        return outputBuffer;\r\n    } catch (error) {\r\n        console.error('[writePngWithMetadata] Error:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Reads a tEXt chunk from PNG\r\n */\r\nfunction readTextChunk(pngBuffer: Buffer, keyword: string): string | null {\r\n    const PNG_SIGNATURE = Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]);\r\n\r\n    if (!pngBuffer.subarray(0, 8).equals(PNG_SIGNATURE)) {\r\n        throw new Error('Invalid PNG signature');\r\n    }\r\n\r\n    let offset = 8;\r\n\r\n    while (offset + 12 <= pngBuffer.length) {\r\n        const length = pngBuffer.readUInt32BE(offset);\r\n        const type = pngBuffer.subarray(offset + 4, offset + 8).toString('ascii');\r\n\r\n        if (offset + 12 + length > pngBuffer.length) break;\r\n\r\n        if (type === 'tEXt') {\r\n            const data = pngBuffer.subarray(offset + 8, offset + 8 + length);\r\n            const nullIndex = data.indexOf(0);\r\n\r\n            if (nullIndex > 0) {\r\n                const chunkKeyword = data.subarray(0, nullIndex).toString('latin1');\r\n                if (chunkKeyword === keyword) {\r\n                    return data.subarray(nullIndex + 1).toString('latin1');\r\n                }\r\n            }\r\n        }\r\n\r\n        if (type === 'IEND') break;\r\n\r\n        offset += 12 + length;\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n/**\r\n * Removes a tEXt chunk with specific keyword\r\n */\r\nfunction removeTextChunk(pngBuffer: Buffer, keyword: string): Buffer {\r\n    const PNG_SIGNATURE = Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]);\r\n\r\n    if (!pngBuffer.subarray(0, 8).equals(PNG_SIGNATURE)) {\r\n        throw new Error('Invalid PNG signature');\r\n    }\r\n\r\n    const chunks: Buffer[] = [PNG_SIGNATURE];\r\n    let offset = 8;\r\n\r\n    while (offset + 12 <= pngBuffer.length) {\r\n        const length = pngBuffer.readUInt32BE(offset);\r\n        const type = pngBuffer.subarray(offset + 4, offset + 8).toString('ascii');\r\n\r\n        if (offset + 12 + length > pngBuffer.length) break;\r\n\r\n        const chunkSize = 12 + length;\r\n        const chunk = pngBuffer.subarray(offset, offset + chunkSize);\r\n\r\n        // Skip tEXt chunks with our keyword\r\n        if (type === 'tEXt') {\r\n            const data = pngBuffer.subarray(offset + 8, offset + 8 + length);\r\n            const nullIndex = data.indexOf(0);\r\n            if (nullIndex > 0) {\r\n                const chunkKeyword = data.subarray(0, nullIndex).toString('latin1');\r\n                if (chunkKeyword === keyword) {\r\n                    offset += chunkSize;\r\n                    continue; // Skip this chunk\r\n                }\r\n            }\r\n        }\r\n\r\n        chunks.push(chunk);\r\n        offset += chunkSize;\r\n\r\n        if (type === 'IEND') break;\r\n    }\r\n\r\n    return Buffer.concat(chunks);\r\n}\r\n\r\n/**\r\n * Inserts a tEXt chunk before IEND\r\n */\r\nfunction insertTextChunk(pngBuffer: Buffer, keyword: string, text: string): Buffer {\r\n    const PNG_SIGNATURE = Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]);\r\n\r\n    if (!pngBuffer.subarray(0, 8).equals(PNG_SIGNATURE)) {\r\n        throw new Error('Invalid PNG signature');\r\n    }\r\n\r\n    // Find IEND position\r\n    let iendPos = -1;\r\n    let offset = 8;\r\n\r\n    while (offset + 8 <= pngBuffer.length) {\r\n        const length = pngBuffer.readUInt32BE(offset);\r\n        const type = pngBuffer.subarray(offset + 4, offset + 8).toString('ascii');\r\n\r\n        if (type === 'IEND') {\r\n            iendPos = offset;\r\n            break;\r\n        }\r\n\r\n        offset += 12 + length;\r\n    }\r\n\r\n    if (iendPos === -1) {\r\n        throw new Error('IEND chunk not found');\r\n    }\r\n\r\n    // Create tEXt chunk\r\n    const keywordBuf = Buffer.from(keyword, 'latin1');\r\n    const textBuf = Buffer.from(text, 'latin1');\r\n    const data = Buffer.concat([keywordBuf, Buffer.from([0]), textBuf]);\r\n\r\n    const lengthBuf = Buffer.alloc(4);\r\n    lengthBuf.writeUInt32BE(data.length, 0);\r\n\r\n    const typeBuf = Buffer.from('tEXt', 'ascii');\r\n\r\n    const crcBuf = Buffer.alloc(4);\r\n    crcBuf.writeUInt32BE(crc32(Buffer.concat([typeBuf, data])), 0);\r\n\r\n    const textChunk = Buffer.concat([lengthBuf, typeBuf, data, crcBuf]);\r\n\r\n    // Combine: before IEND + tEXt chunk + IEND chunk\r\n    return Buffer.concat([\r\n        pngBuffer.subarray(0, iendPos),\r\n        textChunk,\r\n        pngBuffer.subarray(iendPos)\r\n    ]);\r\n}\r\n\r\n/**\r\n * CRC32 calculation for PNG chunks\r\n */\r\nfunction crc32(buffer: Buffer): number {\r\n    let crc = 0xFFFFFFFF;\r\n\r\n    for (let i = 0; i < buffer.length; i++) {\r\n        crc = crc ^ buffer[i];\r\n        for (let j = 0; j < 8; j++) {\r\n            if (crc & 1) {\r\n                crc = (crc >>> 1) ^ 0xEDB88320;\r\n            } else {\r\n                crc = crc >>> 1;\r\n            }\r\n        }\r\n    }\r\n\r\n    return (crc ^ 0xFFFFFFFF) >>> 0;\r\n}\r\n\r\n/**\r\n * Creates an empty PNG (not used by VSCode extension, but keeping for compatibility)\r\n */\r\nexport function createEmptyPng(): Buffer {\r\n    // Minimal 1x1 white PNG\r\n    return Buffer.from([\r\n        0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, // PNG signature\r\n        0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, // IHDR chunk\r\n        0x00, 0x00, 0x03, 0x20, 0x00, 0x00, 0x02, 0x58, // 800x600\r\n        0x08, 0x06, 0x00, 0x00, 0x00, 0xDB, 0x3F, 0x57,\r\n        0x9F, 0x00, 0x00, 0x00, 0x0A, 0x49, 0x44, 0x41, // IDAT chunk (minimal)\r\n        0x54, 0x78, 0x9C, 0x63, 0x00, 0x01, 0x00, 0x00,\r\n        0x05, 0x00, 0x01, 0x0D, 0x0A, 0x2D, 0xB4, 0x00,\r\n        0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, // IEND chunk\r\n        0x42, 0x60, 0x82\r\n    ]);\r\n}\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(784);\n"],"names":["context","static","constructor","openCustomDocument","uri","_openContext","_token","dispose","resolveCustomEditor","document","webviewPanel","webview","options","enableScripts","localResourceRoots","vscode","Uri","joinPath","this","extensionUri","html","getHtmlForWebview","onDidReceiveMessage","async","message","type","updateWebview","updateDocument","data","window","showErrorMessage","error","subscriptions","watcher","workspace","createFileSystemWatcher","RelativePattern","onDidChange","onDidDispose","fileUri","fileData","fs","readFile","console","log","length","diagramData","metadata","readPngMetadata","Buffer","from","substring","postMessage","fileId","fsPath","pngData","toString","raw","png","hasRaw","hasPng","Error","pngBuffer","finalPngBuffer","writePngWithMetadata","writeFile","indexPath","indexBytes","editorUri","asWebviewUri","replace","match","path","startsWith","cspSource","module","exports","require","provider","DrawmotiveEditorProvider","registration","registerCustomEditorProvider","webviewOptions","retainContextWhenHidden","supportsMultipleEditorsPerDocument","push","newDrawingCommand","commands","registerCommand","showSaveDialog","filters","saveLabel","emptyPngData","createEmptyPng","executeCommand","readTextChunk","METADATA_KEY","cleanedBuffer","keyword","PNG_SIGNATURE","subarray","equals","chunks","offset","readUInt32BE","chunkSize","chunk","nullIndex","indexOf","concat","removeTextChunk","outputBuffer","text","iendPos","keywordBuf","textBuf","lengthBuf","alloc","writeUInt32BE","typeBuf","crcBuf","buffer","crc","i","j","crc32","textChunk","insertTextChunk","verifyMetadata","__webpack_module_cache__","__webpack_exports__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","call"],"ignoreList":[],"sourceRoot":""}